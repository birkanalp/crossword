# PUZZLE_GENERATION_SPEC

## Goal
Phase-0.5 scope: continuously generate TR crossword puzzles via a cron-like loop. EN generation is out of scope for this phase. Difficulty is based on word difficulty distribution (not word length). Avoid repeating words using a cooldown strategy.

## Constraints
- max_word_length: 20 (future multi-word/idioms)
- grid_size: dynamic within [8..15] (configurable)
- max_words_per_puzzle: depends on grid size (config)
- Generator runs continuously: each cron tick generates exactly 1 puzzle and moves on.

## Data Model

### words
- id (uuid)
- language (tr|en)
- word (unique per language)
- length (int)
- difficulty (easy|medium|hard|expert)
- freq_score (optional 0..1)
- tags (jsonb)
- definition (nullable)
- clue_source (definition|wiktionary|llm|manual)
- created_at

### word_usage
- word_id (pk, fk -> words.id)
- used_count (int)
- last_used_at (timestamp)
- cooldown_until (timestamp)
- locked (bool)

### levels (existing, extend)
- id
- language
- target_difficulty (easy|medium|hard|expert)
- computed_difficulty_score (0..100)
- grid_size
- word_count
- words_breakdown (jsonb: counts per difficulty)
- quality_score (0..100)
- grid_json
- clues_json
- solution_hash
- auto_generated (bool)
- created_at

### level_words
- level_id
- word_id
- direction (across|down)
- start_x, start_y
- length

### difficulty_profiles
- name (easy|medium|hard|expert)
- ratios (jsonb: {easy,medium,hard,expert})
- grid_min, grid_max
- min_words, max_words
- cooldown_days (int)
- quality_threshold (int)

### generation_jobs
- id
- language
- target_difficulty
- status (queued|running|succeeded|failed)
- attempts
- last_error
- created_at, updated_at

## Difficulty Rules
Difficulty is determined by selected word distribution:
- Easy puzzle: 70% easy, 25% medium, 5% hard, 0% expert
- Medium puzzle: 40% easy, 45% medium, 15% hard
- Hard puzzle: 15% easy, 45% medium, 30% hard, 10% expert
- Expert puzzle: 0-5% easy, 25% medium, 45% hard, 25-30% expert

Computed difficulty score:
- map word difficulty to {easy=1, medium=2, hard=3, expert=4}
- weighted average * 25 => 25..100
- adjust small penalties/bonuses for crossings/obscure tags

## Non-Repetition Policy
- Default cooldown: 30 days (config per difficulty)
- Words with cooldown_until > now are not eligible
- Prefer lower used_count and older last_used_at

## Generation Pipeline (1 puzzle per run)
1) Pick (language, target_difficulty) job or auto-create next
2) Build candidate pool from words table filtered by:
   - language
   - length <= grid_max (current attempt)
   - not locked
   - cooldown_until <= now
3) Select word set using target ratios and word_count range
4) Determine grid_size dynamically:
   - start at grid_min
   - increase if needed up to grid_max
5) Fill grid using deterministic CSP/backtracking:
   - place anchor words first (longer/rarer)
   - MRV heuristic
   - fail-fast on dead ends
6) Generate clues:
   - use definition if present
   - else Wiktionary if available
   - else LLM short clue (max 8 words)
7) Validate:
   - all slots filled
   - crossings consistent
   - duplicates 없음
   - minimum crossing density
8) Score:
   - difficulty_score
   - quality_score
9) Persist:
   - insert level
   - insert level_words
   - update word_usage: used_count++, last_used_at=now, cooldown_until=now+cooldown_days
10) Mark job succeeded
11) Next run generates next puzzle

## Review Workflow (Pending/Approved/Rejected)

All generated puzzles must be created as reviewable drafts.

### levels.review_status
- pending: newly generated by cron
- approved: visible to players
- rejected: not visible to players, contains review_notes

### levels review fields
- review_status (pending|approved|rejected) default 'pending'
- review_notes (text, required when rejected)
- reviewed_by (uuid, admin user id)
- reviewed_at (timestamp)
- generator_version (text)

### Access rules
- Mobile client can only read approved levels.
- Admin app can read pending/rejected and update review_status.

### Generator behavior
- Cron generator ALWAYS inserts levels with review_status='pending'.
- Cron generator NEVER updates review_status.

### Future manual repair flow
- Rejected levels can be reprocessed by a separate manual command/flow.
- This repair flow must NOT block or modify the main cron generation loop.

## Scheduler
- Cron every 1 minute (or 5 minutes)
- Each tick: generate exactly 1 puzzle
- If fail: increment attempts, save last_error, retry with adjusted parameters:
  - increase grid_size
  - relax cooldown (fallback only when pool too small)
  - reshuffle selection

## APIs / Contracts
- Backend owns CONTRACTS updates.
- Level JSON shape must match CONTRACTS/level.schema.json.

## Deliverables (Phase-0.5)
- SQL migrations
- Edge function / generator runner
- Word import scripts (TR-only for Phase-0.5)
- Logs + status updates
- Basic smoke tests